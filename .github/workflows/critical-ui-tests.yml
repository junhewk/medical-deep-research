name: Critical UI Tests

on:
  pull_request:
    branches: [ main, dev, develop ]
  workflow_dispatch:

permissions:
  contents: read

# Split into 3 parallel jobs to:
# 1. Run faster (parallel execution)
# 2. Isolate tests that create databases from those that don't
# 3. Avoid connection pool exhaustion by using fresh servers per job

jobs:
  # Job 1: Form validation tests that don't need authentication
  # Expected runtime: ~1-2 minutes
  form-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false

    - name: Set up PDM
      uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
      with:
        python-version: '3.11'
        cache: true

    - name: Cache pip packages
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlcipher-dev

    - name: Install Python dependencies
      run: pdm sync -d

    - name: Set up Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tests/ui_tests/package.json

    - name: Set up test directories
      run: mkdir -p "$PWD/data/encrypted_databases"

    - name: Initialize database
      env:
        TEST_ENV: true
        LDR_DATA_DIR: ${{ github.workspace }}/data
        LDR_DB_KDF_ITERATIONS: "1000"  # Must match server setting for encryption compatibility
      run: |
        # Use external script for maintainability (see scripts/ci/init_test_database.py)
        cd src
        pdm run python ../scripts/ci/init_test_database.py

    - name: Start test server
      env:
        CI: true
        FLASK_ENV: testing
        TEST_ENV: true
        DISABLE_RATE_LIMITING: true
        SECRET_KEY: test-secret-key-for-ci
        LDR_DATA_DIR: ${{ github.workspace }}/data
        LDR_DB_KDF_ITERATIONS: "1000"  # Reduce from 256000 for faster test user creation
      run: |
        cd src
        pdm run python -m local_deep_research.web.app > server.log 2>&1 &
        for i in {1..30}; do
          if curl -f http://127.0.0.1:5000 2>/dev/null; then
            echo "Server is ready after $i seconds"
            break
          fi
          sleep 1
        done

    - name: Install Node.js dependencies
      run: cd tests/ui_tests && npm ci

    - name: Cache Puppeteer Chrome
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/puppeteer
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('tests/ui_tests/package.json') }}

    - name: Install Puppeteer browser
      run: npx puppeteer browsers install chrome

    - name: Create screenshots directory
      run: mkdir -p tests/ui_tests/screenshots

    - name: Run form validation tests (no auth required)
      env:
        CI: true
        HEADLESS: true
      run: |
        cd tests/ui_tests
        echo "Running registration form validation (no auth)..."
        node test_register_validation.js

    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: form-validation-artifacts
        path: |
          tests/ui_tests/screenshots/
          src/server.log

  # Job 2: Authentication tests that create new users (slow due to encrypted DB creation)
  # Expected runtime: ~5-10 minutes
  auth-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false

    - name: Set up PDM
      uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
      with:
        python-version: '3.11'
        cache: true

    - name: Cache pip packages
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlcipher-dev

    - name: Install Python dependencies
      run: pdm sync -d

    - name: Set up Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tests/ui_tests/package.json

    - name: Set up test directories
      run: mkdir -p "$PWD/data/encrypted_databases"

    - name: Start test server
      env:
        CI: true
        FLASK_ENV: testing
        TEST_ENV: true
        DISABLE_RATE_LIMITING: true
        SECRET_KEY: test-secret-key-for-ci
        LDR_DATA_DIR: ${{ github.workspace }}/data
        LDR_DB_KDF_ITERATIONS: "1000"  # Reduce from 256000 for faster test user creation
      run: |
        cd src
        pdm run python -m local_deep_research.web.app > server.log 2>&1 &
        for i in {1..60}; do
          if curl -f http://127.0.0.1:5000 2>/dev/null; then
            echo "Server is ready after $i seconds"
            break
          fi
          sleep 1
        done

    - name: Install Node.js dependencies
      run: cd tests/ui_tests && npm ci

    - name: Cache Puppeteer Chrome
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/puppeteer
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('tests/ui_tests/package.json') }}

    - name: Install Puppeteer browser
      run: npx puppeteer browsers install chrome

    - name: Create screenshots directory
      run: mkdir -p tests/ui_tests/screenshots

    - name: Run auth tests (creates users - slow due to encrypted DB)
      env:
        CI: true
        HEADLESS: true
      run: |
        cd tests/ui_tests

        echo "Running auth flow test (creates user)..."
        node test_auth_flow.js || exit 1

        echo "Running login validation test (creates user)..."
        node test_login_validation.js || exit 1

        echo "Running registration full flow test..."
        node test_register_full_flow.js || exit 1

    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: auth-test-artifacts
        path: |
          tests/ui_tests/screenshots/
          src/server.log

  # Job 3: Feature tests that use pre-created CI user (fast)
  # Expected runtime: ~3-5 minutes
  feature-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false

    - name: Set up PDM
      uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
      with:
        python-version: '3.11'
        cache: true

    - name: Cache pip packages
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlcipher-dev

    - name: Install Python dependencies
      run: pdm sync -d

    - name: Set up Node.js
      uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: tests/ui_tests/package.json

    - name: Set up test directories
      run: mkdir -p "$PWD/data/encrypted_databases"

    - name: Start test server
      env:
        CI: true
        FLASK_ENV: testing
        TEST_ENV: true
        DISABLE_RATE_LIMITING: true
        SECRET_KEY: test-secret-key-for-ci
        LDR_DATA_DIR: ${{ github.workspace }}/data
        LDR_DB_KDF_ITERATIONS: "1000"  # Reduce from 256000 for faster test user creation
      run: |
        cd src
        pdm run python -m local_deep_research.web.app > server.log 2>&1 &
        for i in {1..30}; do
          if curl -f http://127.0.0.1:5000 2>/dev/null; then
            echo "Server is ready after $i seconds"
            break
          fi
          sleep 1
        done

    - name: Install Node.js dependencies
      run: cd tests/ui_tests && npm ci

    - name: Cache Puppeteer Chrome
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ~/.cache/puppeteer
        key: ${{ runner.os }}-puppeteer-${{ hashFiles('tests/ui_tests/package.json') }}

    - name: Install Puppeteer browser
      run: npx puppeteer browsers install chrome

    - name: Create screenshots directory
      run: mkdir -p tests/ui_tests/screenshots

    - name: Register CI test user
      working-directory: tests/ui_tests
      run: node register_ci_user.js http://127.0.0.1:5000

    - name: Run feature tests (uses CI user - fast)
      env:
        CI: true
        HEADLESS: true
      run: |
        cd tests/ui_tests

        # Note: Validation tests moved to extended-ui-tests.yml for faster critical path:
        # - test_change_password_validation.js
        # - test_settings_validation.js
        # - test_research_form_validation.js

        echo "Running research submit test..."
        node test_research_submit.js || exit 1

        # NOTE: test_research_simple.js removed - redundant with test_research_submit.js

        echo "Running export functionality test..."
        node test_export_functionality.js || exit 1

        echo "Running concurrent limit test..."
        node test_concurrent_limit.js || exit 1

    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: feature-test-artifacts
        path: |
          tests/ui_tests/screenshots/
          src/server.log
