name: Publish Docker image

# SECURITY: Only triggered via repository_dispatch from release.yml
# (after security gate passes). We intentionally do NOT support
# workflow_dispatch because that would bypass security checks.
# To re-publish, trigger a new release through release.yml.
on:
  repository_dispatch:
    types: [publish-docker]

permissions: {}  # Minimal top-level for OSSF Scorecard Token-Permissions

jobs:
  build-amd64:
    name: Build AMD64 Image
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push AMD64 image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/local-deep-research:amd64-${{ github.sha }}
          cache-from: type=gha,scope=linux-amd64
          cache-to: type=gha,mode=max,scope=linux-amd64
          build-args: |
            DEPS_HASH=${{ hashFiles('pdm.lock') }}

  build-arm64:
    name: Build ARM64 Image
    runs-on: ubuntu-24.04-arm
    environment: release
    permissions:
      contents: read
    outputs:
      digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push ARM64 image
        id: build
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/arm64
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/local-deep-research:arm64-${{ github.sha }}
          cache-from: type=gha,scope=linux-arm64
          cache-to: type=gha,mode=max,scope=linux-arm64
          build-args: |
            DEPS_HASH=${{ hashFiles('pdm.lock') }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Free disk space
        run: |
          # Remove unnecessary packages to free up space for Docker build + Trivy scan
          # GitHub runners have limited space; Trivy needs to export the full image to /tmp
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /opt/ghc || true
          sudo rm -rf /opt/hostedtoolcache/CodeQL || true
          sudo docker image prune --all --force || true
          df -h

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Build Docker image for security scan
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6
        with:
          context: .
          platforms: linux/amd64
          push: false
          load: true
          tags: local-deep-research:security-scan
          cache-from: type=gha,scope=linux-amd64
          cache-to: type=gha,mode=max,scope=linux-amd64
          build-args: |
            DEPS_HASH=${{ hashFiles('pdm.lock') }}

      # Generate SARIF report for GitHub Security tab (all severities, doesn't fail)
      - name: Generate Trivy SARIF report
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # master
        with:
          image-ref: local-deep-research:security-scan
          format: 'sarif'
          output: 'trivy-release-scan.sarif'
          ignore-unfixed: true
          exit-code: '0'

      # Separate scan that fails build only on fixable HIGH/CRITICAL vulnerabilities
      - name: Check for fixable HIGH/CRITICAL vulnerabilities
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # master
        with:
          image-ref: local-deep-research:security-scan
          severity: 'CRITICAL,HIGH'
          ignore-unfixed: true  # Only fail on vulnerabilities with available fixes
          trivyignores: '.trivyignore'  # Ignore bundled library CVEs that can't be fixed
          exit-code: '1'

      - name: Upload Trivy scan results from release
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: trivy-release-scan
          path: trivy-release-scan.sarif
          retention-days: 7  # Reduced for security

  create-manifest:
    name: Create Multi-Platform Manifest
    needs: [build-amd64, build-arm64, security-scan]
    runs-on: ubuntu-latest
    environment: release
    permissions:
      contents: read
      id-token: write  # Required for Sigstore keyless signing
      packages: write

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
        with:
          egress-policy: audit

      - name: Check out the repo
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3

      - name: Log in to Docker Hub
        uses: docker/login-action@c94ce9fb468520275223c153574b00df6fe4bcc9 # v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Install Cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0

      - name: Install Syft
        uses: anchore/sbom-action/download-syft@deef08a0db64bfad603422135db61477b16cef56 # v0.22.1

      - name: Determine version tag
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          DISPATCH_TAG: ${{ github.event.client_payload.tag }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
        run: |
          set -euo pipefail
          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            TAG="$DISPATCH_TAG"
          else
            TAG="$RELEASE_TAG"
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          # Extract version without 'v' prefix
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          # Extract major.minor
          MAJOR_MINOR=$(echo "$VERSION" | cut -d. -f1,2)
          echo "major_minor=$MAJOR_MINOR" >> "$GITHUB_OUTPUT"

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ secrets.DOCKER_USERNAME }}/local-deep-research
          tags: |
            type=raw,value=${{ steps.version.outputs.version }}
            type=raw,value=${{ steps.version.outputs.major_minor }}
            type=raw,value=latest

      - name: Create and push multi-platform manifest
        id: manifest
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          META_TAGS: ${{ steps.meta.outputs.tags }}
        run: |
          set -euo pipefail
          # Get the tags from metadata (newline separated)
          TAGS="$META_TAGS"

          # Store first tag for attestation
          FIRST_TAG=$(echo "$TAGS" | head -n 1)
          echo "primary_tag=$FIRST_TAG" >> "$GITHUB_OUTPUT"

          # Create manifest for each tag
          while IFS= read -r tag; do
            if [ -n "$tag" ]; then
              echo "Creating manifest for: $tag"
              docker buildx imagetools create -t "$tag" \
                "${DOCKER_USERNAME}/local-deep-research:amd64-${{ github.sha }}" \
                "${DOCKER_USERNAME}/local-deep-research:arm64-${{ github.sha }}"
            fi
          done <<< "$TAGS"

          # Get the manifest digest for the primary tag (used for signing)
          DIGEST=$(docker buildx imagetools inspect "$FIRST_TAG" --format '{{json .Manifest.Digest}}' | tr -d '"')
          echo "digest=$DIGEST" >> "$GITHUB_OUTPUT"
          echo "Manifest digest: $DIGEST"

      - name: Sign Docker images with Cosign
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          set -euo pipefail
          # Sign by digest for reliability with manifest lists
          # All tags point to the same manifest, so we sign once by digest
          IMAGE_REF="${DOCKER_USERNAME}/local-deep-research@${DIGEST}"
          echo "Signing image by digest: $IMAGE_REF"
          cosign sign --yes "$IMAGE_REF"

          # Brief sleep to allow registry to propagate signature
          echo "Waiting for signature propagation..."
          sleep 5

      - name: Generate SLSA provenance attestation
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          set -euo pipefail
          IMAGE_REF="${DOCKER_USERNAME}/local-deep-research@${DIGEST}"

          # Generate SLSA provenance predicate
          # Note: SLSA spec requires "sha1" field name for git commit digest
          cat > provenance.json <<EOF
          {
            "buildType": "https://github.com/${{ github.repository }}/docker-build@v1",
            "builder": {
              "id": "https://github.com/actions/runner"
            },
            "invocation": {
              "configSource": {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                },
                "entryPoint": ".github/workflows/docker-publish.yml"
              }
            },
            "metadata": {
              "buildInvocationId": "${{ github.run_id }}",
              "buildStartedOn": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "completeness": {
                "parameters": true,
                "environment": true,
                "materials": true
              },
              "reproducible": false
            },
            "materials": [
              {
                "uri": "https://github.com/${{ github.repository }}",
                "digest": {
                  "sha1": "${{ github.sha }}"
                }
              }
            ]
          }
          EOF

          # Attach provenance to image by digest
          cosign attest --yes --predicate provenance.json --type slsaprovenance "$IMAGE_REF"

      - name: Verify image signature
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          set -euo pipefail
          IMAGE_REF="${DOCKER_USERNAME}/local-deep-research@${DIGEST}"
          echo "Verifying signature for: $IMAGE_REF"

          # Retry logic to handle registry propagation delay after signing
          MAX_RETRIES=5
          RETRY_DELAY=10
          for i in $(seq 1 "$MAX_RETRIES"); do
            echo "Verification attempt $i of $MAX_RETRIES..."
            if cosign verify \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}" \
              --certificate-oidc-issuer=https://token.actions.githubusercontent.com \
              "$IMAGE_REF"; then
              echo "Signature verification successful!"
              exit 0
            fi
            if [ "$i" -lt "$MAX_RETRIES" ]; then
              echo "Verification failed, waiting ${RETRY_DELAY}s before retry..."
              sleep "$RETRY_DELAY"
            fi
          done
          echo "Signature verification failed after $MAX_RETRIES attempts"
          exit 1

      - name: Attach SBOM to image
        env:
          DIGEST: ${{ steps.manifest.outputs.digest }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        run: |
          set -euo pipefail
          IMAGE_REF="${DOCKER_USERNAME}/local-deep-research@${DIGEST}"

          # Generate SBOM using syft
          docker pull "$IMAGE_REF"
          syft "$IMAGE_REF" -o spdx-json > sbom.spdx.json

          # Attach SBOM to image by digest
          cosign attach sbom --sbom sbom.spdx.json "$IMAGE_REF"

          # Sign the SBOM
          cosign sign --yes --attachment sbom "$IMAGE_REF"

      - name: Upload SBOM artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom
          path: sbom.spdx.json
          retention-days: 90

      - name: Clean up temporary tags
        run: |
          echo "Manifest creation complete. Temporary platform-specific tags can be removed manually if desired."
