name: Security Tests

on:
  workflow_call:  # Called by security-release-gate.yml
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # Required for uploading SARIF results to Code Scanning

jobs:
  security-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    services:
      postgres:
        image: postgres:13@sha256:1094e2cdc5605e5c7914633bcd93758a9c52ae8c8b2855ddd1c3a8afbe4795d5 # postgres:13
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_security_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
    - name: Harden the runner (Audit all outbound calls)
      uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2.14.1
      with:
        egress-policy: audit

    - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        persist-credentials: false

    - name: Set up Python 3.11
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: '3.11'

    - name: Cache pip packages
      uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-security-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-security-
          ${{ runner.os }}-pip-

    - name: Set up PDM
      uses: pdm-project/setup-pdm@94a823180e06fcde4ad29308721954a521c96ed0 # v4
      with:
        python-version: '3.11'

    - name: Install system dependencies for SQLCipher
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlcipher-dev

    - name: Install dependencies
      run: |
        pdm sync -d
        pdm add "bandit[sarif]" safety sqlparse pytest pytest-cov --no-sync
        pdm sync

    - name: Run Bandit security linter
      run: |
        # Generate JSON report for artifact upload
        pdm run bandit -r src/ -f json -o bandit-report.json -lll || true
        # Generate SARIF report for GitHub Code Scanning
        pdm run bandit -r src/ -f sarif -o bandit-results.sarif -lll || true
        if [ -f bandit-report.json ]; then
          echo "Bandit security scan completed"
        fi

    - name: Upload Bandit SARIF to Code Scanning
      uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30 # v4.32.0
      if: always()
      with:
        sarif_file: bandit-results.sarif
        category: bandit

    # Using official pip-audit action with SHA-pinning for OSSF Scorecard compliance
    # This replaces pip install pip-audit==2.10.0 with container-based approach
    - name: Check for known vulnerabilities with pip-audit
      uses: pypa/gh-action-pip-audit@14a8ce5eb2fef3dba4886c7b0a3d0bab42a66864 # main
      with:
        inputs: .
        vulnerability-service: osv
        summary: true

    - name: Run SQL injection tests
      env:
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/test_security_db
      run: |
        # Run SQL injection specific tests
        pdm run python -m pytest tests/security/test_sql_injection.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_sql_injection_prevention.py ]; then
          pdm run python -m pytest tests/test_sql_injection_prevention.py -v --tb=short -n auto
        fi

    - name: Run XSS prevention tests
      run: |
        pdm run python -m pytest tests/security/test_xss_prevention.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_xss_prevention.py ]; then
          pdm run python -m pytest tests/test_xss_prevention.py -v --tb=short -n auto
        fi

    - name: Run CSRF protection tests
      run: |
        pdm run python -m pytest tests/security/test_csrf_protection.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_csrf_protection.py ]; then
          pdm run python -m pytest tests/test_csrf_protection.py -v --tb=short -n auto
        fi

    - name: Run authentication security tests
      run: |
        pdm run python -m pytest tests/security/test_auth_security.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_password_security.py ]; then
          pdm run python -m pytest tests/test_password_security.py -v --tb=short -n auto
        fi
        if [ -f tests/test_session_security.py ]; then
          pdm run python -m pytest tests/test_session_security.py -v --tb=short -n auto
        fi

    - name: Run cookie security tests
      run: |
        pdm run python -m pytest tests/security/test_cookie_security.py -v --tb=short -n auto

    - name: Run API security tests
      run: |
        pdm run python -m pytest tests/security/test_api_security.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_rate_limiting.py ]; then
          pdm run python -m pytest tests/test_rate_limiting.py -v --tb=short -n auto
        fi
        if [ -f tests/test_api_authentication.py ]; then
          pdm run python -m pytest tests/test_api_authentication.py -v --tb=short -n auto
        fi

    - name: Run input validation tests
      run: |
        pdm run python -m pytest tests/security/test_input_validation.py -v --tb=short -n auto
        # Legacy tests (if they exist)
        if [ -f tests/test_input_sanitization.py ]; then
          pdm run python -m pytest tests/test_input_sanitization.py -v --tb=short -n auto
        fi

    - name: Run SSRF protection tests
      run: |
        pdm run python -m pytest tests/security/test_ssrf_validator.py -v --tb=short -n auto
        pdm run python -m pytest tests/security/test_safe_requests_hook.py -v --tb=short -n auto

    - name: Run session security constant tests
      run: |
        pdm run python -m pytest tests/security/test_session_constants.py -v --tb=short -n auto

    - name: Check for hardcoded secrets
      run: |
        # Check for potential secrets in code
        grep -r -E "(api[_-]?key|secret[_-]?key|password|token)" src/ --include="*.py" | \
          grep -v -E "(os\.environ|getenv|config\[|placeholder|example|test)" | \
          grep -E "=\s*['\"]" || echo "No hardcoded secrets found"

    - name: Generate security report
      if: always()
      run: |
        echo "Security Test Report"
        echo "==================="
        echo ""
        if [ -f bandit-report.json ]; then
          echo "Bandit Security Issues:"
          python -c "import json; data=json.load(open('bandit-report.json')); print(f'  High: {len([i for i in data.get(\"results\", []) if i[\"issue_severity\"] == \"HIGH\"])}'); print(f'  Medium: {len([i for i in data.get(\"results\", []) if i[\"issue_severity\"] == \"MEDIUM\"])}'); print(f'  Low: {len([i for i in data.get(\"results\", []) if i[\"issue_severity\"] == \"LOW\"])}')" || true
        fi
        echo ""
        echo "pip-audit results: See job summary above (summary: true enabled)"

    - name: Upload security reports
      if: always()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: security-reports
        path: |
          bandit-report.json
          bandit-results.sarif
